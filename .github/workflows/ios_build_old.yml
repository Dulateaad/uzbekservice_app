name: Build iOS IPA

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Generate Flutter files
        run: flutter precache --ios
      
      - name: Setup CocoaPods
        run: |
          cd ios
          sudo gem install cocoapods
          pod install --repo-update
      
      - name: Setup Xcode code signing
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          # Create keychain for signing
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Add Apple ID to Xcode
          echo "Adding Apple ID to Xcode..."
          xcrun altool --store-password-in-keychain-item "AC_PASSWORD" -u "$APPLE_ID" -p "$APPLE_ID_PASSWORD" || true
      
      - name: Configure code signing in Xcode project
        env:
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          cd ios
          # Set team ID in project file
          sed -i '' "s/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = $TEAM_ID;/g" Runner.xcodeproj/project.pbxproj || true
          sed -i '' "s/DevelopmentTeam = .*/DevelopmentTeam = $TEAM_ID;/g" Runner.xcodeproj/project.pbxproj || true
          
          # Ensure automatic signing is enabled
          sed -i '' "s/ProvisioningStyle = Manual/ProvisioningStyle = Automatic/g" Runner.xcodeproj/project.pbxproj || true
          sed -i '' "s/CODE_SIGN_STYLE = Manual/CODE_SIGN_STYLE = Automatic/g" Runner.xcodeproj/project.pbxproj || true
      
      - name: Build IPA with automatic signing
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          # Build with automatic code signing
          flutter build ipa --release --no-codesign || flutter build ipa --release
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa
          retention-days: 30
      
      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build/ios/**/*.log
            build/**/*.log
          retention-days: 7
